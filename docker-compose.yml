# Extension: single Rust build definition (built once, shared by all Rust services)
x-rust-image: &rust-image
  image: aubit-rust:latest
  build:
    context: .
    dockerfile: Dockerfile.trade-executor

x-rust-env: &rust-env
  env_file:
    - .env
  environment:
    DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
    RUST_LOG: info
  networks:
    - aubit-net

services:
  # trade-executor:
  #   <<: *rust-image
  #   <<: *rust-env
  #   container_name: trade-executor
  #   command: >
  #     --dry-run=false
  #     --verbose-timing
  #     --assets BTC,ETH,SOL,XRP
  #     --max-time-to-expiry 3600
  #     --max-orderbook-age 30
  #     --min-profit 0.02
  #     --max-position-size 10
  #   restart: unless-stopped

  # This service triggers the single Rust image build
  orderbook-stream:
    <<: [*rust-image, *rust-env]
    container_name: orderbook-stream
    entrypoint: ["orderbook-stream"]
    command: >
      --hybrid
      --crypto-hours 1
      --crypto-limit 500
      --event-limit 0
      --reconnect-interval 30
    restart: unless-stopped

  market-scanner:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: market-scanner
    entrypoint: ["market-scanner"]
    command: --interval 60
    restart: unless-stopped

  # expiry-scalper:
  #   image: aubit-rust:latest
  #   <<: *rust-env
  #   container_name: expiry-scalper
  #   entrypoint: ["expiry-scalper"]
  #   command: >
  #     --interval-secs 10
  #     --expiry-minutes 3
  #     --position-size 5
  #     --high-threshold 0.75
  #   restart: unless-stopped

  contrarian-scalper:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: contrarian-scalper
    entrypoint: ["expiry-scalper"]
    command: >
      --interval-secs 5
      --expiry-minutes 1
      --position-size 2
      --limit-price 0.99
      --high-threshold 0.70
      --contrarian
      --only-15m-updown
      --dry-run
    restart: unless-stopped

  momentum-trader:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: momentum-trader
    entrypoint: ["momentum-trader"]
    command: >
      --dry-run
      --min-momentum 0.002
      --lookback-minutes 5
      --max-entry-price 0.70
      --position-size 5
      --max-expiry-minutes 10
      --min-expiry-minutes 1
      --cooldown-secs 900
      --max-orderbook-age 1
      --assets BTC,ETH,SOL,XRP
    restart: unless-stopped

  misprice-trader:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: misprice-trader
    entrypoint: ["misprice-trader"]
    command: >
      --dry-run
      --limit-price 0.40
      --position-size 5
      --max-expiry-minutes 10
      --min-expiry-minutes 1
      --max-orderbook-age 1
      --assets BTC
    restart: unless-stopped

  misprice-trader-trailing:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: misprice-trader-trailing
    entrypoint: ["misprice-trader"]
    command: >
      --trailing-stop-pct 0.10
      --limit-price 0.40
      --position-size 12
      --max-expiry-minutes 15
      --min-expiry-minutes 1
      --max-orderbook-age 1
      --assets BTC,ETH,SOL,XRP
      --timeframes 15m
    restart: unless-stopped

  misprice-trader-trailing-5m:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: misprice-trader-trailing-5m
    entrypoint: ["misprice-trader"]
    command: >
      --dry-run
      --trailing-stop-pct 0.10
      --limit-price 0.40
      --position-size 5
      --max-expiry-minutes 5
      --min-expiry-minutes 1
      --max-orderbook-age 1
      --assets BTC,ETH,SOL,XRP
      --timeframes 5m
    restart: unless-stopped

  misprice-trader-chainlink:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: misprice-trader-chainlink
    entrypoint: ["misprice-trader-chainlink"]
    command: >
      --dry-run
      --limit-price 0.40
      --position-size 5
      --max-expiry-minutes 15
      --min-expiry-minutes 1
      --max-orderbook-age 1
      --assets BTC,ETH,SOL,XRP
    restart: unless-stopped

  poly-check:
    image: aubit-rust:latest
    container_name: poly-check
    entrypoint: ["poly-check"]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
    profiles:
      - tools
    networks:
      - aubit-net

  audit-prices:
    image: aubit-rust:latest
    <<: *rust-env
    container_name: audit-prices
    entrypoint: []
    command: ["sh", "-c", "while true; do poly-check --audit-prices --audit-limit 20 --audit-assets BTC,ETH,SOL,XRP; echo '--- Sleeping 30s ---'; sleep 30; done"]
    restart: unless-stopped

  position-redeemer:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: position-redeemer
    env_file:
      - .env
    command: ["sh", "-c", "while true; do echo '=== Checking for redeemable positions ===' && uv run python redeem.py --all --execute 2>&1 || true; echo '--- Sleeping 5m ---'; sleep 300; done"]
    restart: unless-stopped
    networks:
      - aubit-net

  cross-platform-arb:
    image: aubit-rust:latest
    container_name: cross-platform-arb
    entrypoint: ["cross-platform-arb"]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
      RUST_LOG: cross_platform_arb=info,common=warn,sqlx=warn
    command: >
      --interval 30
      --min-profit 3.5
      --min-profit-15m 1.0
      --min-liquidity 500
      --max-orderbook-age 30
      --max-expiry-secs 7200
      --min-match-confidence 0.9
      --assets BTC,ETH,SOL,XRP
    restart: unless-stopped
    networks:
      - aubit-net

  limitless-loader:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: limitless-loader
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
    command: ["sh", "-c", "while true; do echo '=== Loading Limitless markets ===' && uv run python pylo/tools/load_limitless.py 2>&1 || true; echo '--- Sleeping 30s ---'; sleep 30; done"]
    restart: unless-stopped
    networks:
      - aubit-net

  # kalshi-orderbook-stream:
  #   image: aubit-rust:latest
  #   <<: *rust-env
  #   container_name: kalshi-orderbook-stream
  #   entrypoint: ["kalshi-orderbook-stream"]
  #   command: >
  #     --max-expiry-hours 2
  #     --refresh-interval 300
  #     --assets BTC,ETH,SOL,XRP
  #   restart: unless-stopped

networks:
  aubit-net:
    external: true

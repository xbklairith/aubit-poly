services:
  trade-executor:
    build:
      context: .
      dockerfile: Dockerfile.trade-executor
    container_name: trade-executor
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
      RUST_LOG: info
    command: >
      --dry-run=false
      --verbose-timing
      --assets BTC,ETH,SOL,XRP
      --max-time-to-expiry 3600
      --max-orderbook-age 30
      --min-profit 0.02
      --max-position-size 10
    restart: unless-stopped
    networks:
      - aubit-net

  orderbook-stream:
    build:
      context: .
      dockerfile: Dockerfile.trade-executor
    container_name: orderbook-stream
    entrypoint: ["orderbook-stream"]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
      RUST_LOG: info
    command: >
      --hybrid
      --crypto-hours 1
      --crypto-limit 100
      --event-limit 0
      --reconnect-interval 20
    restart: unless-stopped
    networks:
      - aubit-net

  market-scanner:
    build:
      context: .
      dockerfile: Dockerfile.trade-executor
    container_name: market-scanner
    entrypoint: ["market-scanner"]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
      RUST_LOG: info
    command: --interval 60
    restart: unless-stopped
    networks:
      - aubit-net

  poly-check:
    build:
      context: .
      dockerfile: Dockerfile.trade-executor
    container_name: poly-check
    entrypoint: ["poly-check"]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
    profiles:
      - tools
    networks:
      - aubit-net

  audit-prices:
    build:
      context: .
      dockerfile: Dockerfile.trade-executor
    container_name: audit-prices
    entrypoint: []
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://aubit:aubit_dev_password@aubit-poly-db:5432/aubit_poly
      RUST_LOG: info
    command: ["sh", "-c", "while true; do poly-check --audit-prices --audit-limit 20 --audit-assets BTC,ETH,SOL,XRP; echo '--- Sleeping 30s ---'; sleep 30; done"]
    restart: unless-stopped
    networks:
      - aubit-net

  position-redeemer:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: position-redeemer
    env_file:
      - .env
    command: ["sh", "-c", "while true; do echo '=== Checking for redeemable positions ===' && uv run python redeem.py --all --execute 2>&1 || true; echo '--- Sleeping 60s ---'; sleep 60; done"]
    restart: unless-stopped
    networks:
      - aubit-net

networks:
  aubit-net:
    external: true
